#!/bin/bash

# Development setup script for vglist
# This script sets up the development environment according to CONTRIBUTING.md

set -e

echo "🚀 Setting up vglist development environment..."

# Check if Docker and Docker Compose are available
# Note: Use 'docker compose' (V2) instead of 'docker-compose' (V1)
if command -v docker &> /dev/null && docker compose version &> /dev/null; then
    echo "📦 Using Docker Compose for development setup..."
    
    # Build and start services
    docker compose up -d --build
    
    echo "⏳ Waiting for services to be ready..."
    sleep 10
    
    # Run database setup
    docker compose exec web bundle exec rails db:setup
    
    echo "✅ Development environment is ready!"
    echo "🌐 Rails app: http://localhost:3000"
    echo "📦 Webpack dev server: http://localhost:3035"
    echo ""
    echo "💡 Use 'docker compose logs -f' to view logs"
    echo "💡 Use 'docker compose exec web bash' to access the Rails container"
    echo "💡 Use 'docker compose down' to stop all services"
    
else
    echo "🔧 Setting up development environment locally..."
    
    # Check Ruby version
    if ! ruby -v | grep -q "ruby 3.4"; then
        echo "❌ Ruby 3.4 is required. Please install Ruby 3.4 first."
        exit 1
    fi
    
    # Check Node.js version
    if ! node -v | grep -q "v16"; then
        echo "❌ Node.js 16.x is required. Please install Node.js 16.x first."
        exit 1
    fi
    
    # Check if PostgreSQL is running
    if ! pg_isready -h localhost -p 5432 &> /dev/null; then
        echo "❌ PostgreSQL is not running. Please start PostgreSQL first."
        exit 1
    fi
    
    # Install bundler
    gem install bundler:2.7.1
    
    # Install dependencies
    bundle install
    yarn install
    
    # Setup database
    bundle exec rails db:setup
    
    echo "✅ Development environment is ready!"
    echo "🌐 Start the server with: bundle exec rails server"
    echo "📦 Start webpack dev server with: bin/webpack-dev-server"
fi