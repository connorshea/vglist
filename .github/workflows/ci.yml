name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions: {}

env:
  RAILS_ENV: test
  RACK_ENV: test
  NODE_ENV: test

jobs:
  rubocop:
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: ruby/setup-ruby@v1.288.0
        with:
          ruby-version: '3.4.6'
          bundler-cache: true
      - run: bundle exec rubocop

  typescript:
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
      - run: corepack enable
      - run: yarn install --frozen-lockfile
      - run: yarn run tsc --noEmit
      - run: yarn run vue-tsc --noEmit

  graphql_lint:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: ci_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ''
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: ruby/setup-ruby@v1.288.0
        with:
          ruby-version: '3.4.6'
          bundler-cache: true
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          cache: yarn
      - run: yarn install --frozen-lockfile
      - run: cp config/database.yml.ci config/database.yml
      - run: bundle exec rails db:create
      - run: bundle exec rails db:schema:load
      - run: bundle exec rake graphql:schema:idl
      - run: yarn graphql-schema-linter schema.graphql

  factory_bot_lint:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: ci_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ''
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libvips-tools imagemagick
      - uses: ruby/setup-ruby@v1.288.0
        with:
          ruby-version: '3.4.6'
          bundler-cache: true
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: yarn
      - run: yarn install --frozen-lockfile
      - run: cp config/database.yml.ci config/database.yml
      - run: bundle exec rails db:create
      - run: bundle exec rails db:schema:load
      - run: bundle exec rake factory_bot:lint

  rspec:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: ci_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ''
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libvips-tools imagemagick
      - uses: ruby/setup-ruby@v1.288.0
        with:
          ruby-version: '3.4.6'
          bundler-cache: true
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          cache: yarn
      - run: yarn install --frozen-lockfile
      - run: cp config/database.yml.ci config/database.yml
      - run: bundle exec rails db:create
      - run: bundle exec rails db:schema:load
      - run: bundle exec rails zeitwerk:check
      - run: bundle exec rake assets:precompile
      - run: bundle exec rspec
      - name: Coverage summary
        if: always()
        run: |
          if [ -f coverage/.last_run.json ]; then
            covered=$(ruby -rjson -e 'puts JSON.parse(File.read("coverage/.last_run.json"))["result"]["line"]')
            echo "## Code Coverage" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**${covered}%** line coverage" >> "$GITHUB_STEP_SUMMARY"
          fi
      - uses: actions/upload-artifact@v6.0.0
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 10

  db_seed:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: ci_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ''
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: ruby/setup-ruby@v1.288.0
        with:
          ruby-version: '3.4.6'
          bundler-cache: true
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          cache: yarn
      - run: yarn install --frozen-lockfile
      - run: cp config/database.yml.ci config/database.yml
      - run: bundle exec rails db:create
      - run: bundle exec rails db:schema:load
      - run: bundle exec rails db:seed
